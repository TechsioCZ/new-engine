x-medusa-env: &medusa-env
  NODE_ENV: ${DC_NODE_ENV:-development}
  JWT_SECRET: ${DC_JWT_SECRET:-supersecret}
  COOKIE_SECRET: ${DC_COOKIE_SECRET:-supersecret}
  DATABASE_TYPE: postgres
  # Force all Medusa module DB clients (MikroORM/Knex) to use the app schema.
  MEDUSA_DATABASE_SCHEMA: ${DC_MEDUSA_APP_DB_SCHEMA:-medusa}
  DATABASE_SCHEMA: ${DC_MEDUSA_APP_DB_SCHEMA:-medusa}
  DATABASE_URL: postgresql://${DC_MEDUSA_APP_DB_USER:-medusa_app}:${DC_MEDUSA_APP_DB_PASSWORD:-medusa_app_change_me}@medusa-db:5432/${DC_MEDUSA_APP_DB_NAME:-medusa}?sslmode=${DC_POSTGRES_SSLMODE:-disable}&options=-csearch_path%3D${DC_MEDUSA_APP_DB_SCHEMA:-medusa}%2Cpg_catalog
  LEGACY_DATABASE_URL: ${DC_LEGACY_DATABASE_URL}
  MINIO_FILE_URL: ${DC_MINIO_FILE_URL}
  MINIO_REGION: ${DC_MINIO_REGION}
  MINIO_ENDPOINT: ${DC_MINIO_ENDPOINT}
  MINIO_BUCKET: ${DC_MINIO_BUCKET}
  MINIO_ACCESS_KEY: ${DC_MINIO_ACCESS_KEY}
  MINIO_SECRET_KEY: ${DC_MINIO_SECRET_KEY}
  REDIS_URL: ${DC_REDIS_URL}
  MEILISEARCH_HOST: ${DC_MEILISEARCH_HOST}
  MEILISEARCH_API_KEY: ${DC_MEILISEARCH_API_KEY}
  STORE_CORS: ${DC_STORE_CORS}
  ADMIN_CORS: ${DC_ADMIN_CORS}
  AUTH_CORS: ${DC_AUTH_CORS}
  SENTRY_NAME: ${DC_SENTRY_NAME}
  SENTRY_DSN: ${DC_SENTRY_DSN}
  SETTINGS_ENCRYPTION_KEY: ${DC_SETTINGS_ENCRYPTION_KEY}
  FEATURE_PPL_ENABLED: ${DC_FEATURE_PPL_ENABLED:-0}
  PPL_ENVIRONMENT: ${DC_PPL_ENVIRONMENT:-testing}

x-zane-operator-db-env: &zane-operator-db-env
  PGHOST: medusa-db
  PGPORT: 5432
  PGUSER: ${DC_ZANE_OPERATOR_PGUSER:-zane_operator}
  PGPASSWORD: ${DC_ZANE_OPERATOR_PGPASSWORD:-replace-me}
  PGDATABASE: ${DC_ZANE_OPERATOR_PGDATABASE:-postgres}
  PGSSLMODE: ${DC_POSTGRES_SSLMODE:-disable}
  DB_TEMPLATE_NAME: ${DC_ZANE_OPERATOR_DB_TEMPLATE_NAME:-template_medusa}
  DB_PREVIEW_PREFIX: ${DC_ZANE_OPERATOR_DB_PREVIEW_PREFIX:-medusa_pr_}
  DB_PREVIEW_OWNER: ${DC_ZANE_OPERATOR_PGUSER:-zane_operator}
  DB_PREVIEW_APP_USER_PREFIX: ${DC_ZANE_OPERATOR_DB_PREVIEW_APP_USER_PREFIX:-medusa_pr_app_}
  DB_PREVIEW_DEV_ROLE: ${DC_MEDUSA_DEV_DB_USER:-medusa_dev}
  DB_APP_SCHEMA: ${DC_MEDUSA_APP_DB_SCHEMA:-medusa}
  DB_PREVIEW_APP_PASSWORD_SECRET: ${DC_ZANE_OPERATOR_DB_PREVIEW_APP_PASSWORD_SECRET:-replace-me}
  DB_PROTECTED_NAMES: ${DC_ZANE_OPERATOR_DB_PROTECTED_NAMES:-demo,postgres,template0,template1,template_medusa}

x-zane-operator-env: &zane-operator-env
  PORT: ${DC_ZANE_OPERATOR_PORT:-8080}
  NODE_ENV: ${DC_NODE_ENV:-development}
  API_AUTH_TOKEN: ${DC_ZANE_OPERATOR_API_AUTH_TOKEN:-replace-me}
  <<: *zane-operator-db-env

x-medusa-base: &medusa-base
  restart: unless-stopped
  container_name: wr_medusa_be
  ports:
    - "9000:9000"
    - "9009:9009"
    - "24678:24678"
  depends_on:
    - medusa-db
    - medusa-valkey
    - medusa-minio
    - medusa-meilisearch
  networks:
    - internal
  environment:
    <<: *medusa-env

x-n1-env: &n1-env
  MEDUSA_BACKEND_URL_INTERNAL: ${DC_N1_MEDUSA_BACKEND_URL_INTERNAL:-http://medusa-be:9000}
  NEXT_PUBLIC_MEDUSA_BACKEND_URL: ${DC_N1_NEXT_PUBLIC_MEDUSA_BACKEND_URL:-http://localhost:9000}
  NEXT_PUBLIC_MEDUSA_PUBLISHABLE_KEY: ${DC_N1_NEXT_PUBLIC_MEDUSA_PUBLISHABLE_KEY:-}
  NEXT_PUBLIC_MEILISEARCH_URL: ${DC_N1_NEXT_PUBLIC_MEILISEARCH_URL:-http://localhost:7700}
  NEXT_PUBLIC_MEILISEARCH_API_KEY: ${DC_N1_NEXT_PUBLIC_MEILISEARCH_API_KEY:-}
  NEXT_PUBLIC_SITE_URL: ${DC_N1_NEXT_PUBLIC_SITE_URL:-http://localhost:8000}
  NEXT_PUBLIC_META_PIXEL_ID: ${DC_N1_NEXT_PUBLIC_META_PIXEL_ID:-}
  NEXT_PUBLIC_GOOGLE_ADS_ID: ${DC_N1_NEXT_PUBLIC_GOOGLE_ADS_ID:-}
  NEXT_PUBLIC_HEUREKA_API_KEY: ${DC_N1_NEXT_PUBLIC_HEUREKA_API_KEY:-}
  NEXT_PUBLIC_LEADHUB_TRACKING_ID: ${DC_N1_NEXT_PUBLIC_LEADHUB_TRACKING_ID:-}
  RESEND_API_KEY: ${DC_N1_MEDUSA_RESEND_API_KEY:-}
  CONTACT_EMAIL: ${DC_N1_MEDUSA_CONTACT_EMAIL:-}
  RESEND_FROM_EMAIL: ${DC_N1_MEDUSA_RESEND_FROM_EMAIL:-}

services:
  # DEV MODE (default): docker compose up
  # PROD MODE: docker compose -f docker-compose.yaml -f docker-compose.prod.yaml up --build
  medusa-be:
    <<: *medusa-base
    build:
      context: .
      dockerfile: docker/development/medusa-be/Dockerfile
      target: dev
    volumes:
      - .:/var/www
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/app"]
      start_period: 20s
      interval: 10s
  n1:
    restart: unless-stopped
    container_name: wr_n1
    build:
      context: .
      dockerfile: docker/development/n1/Dockerfile
      target: dev
      args:
        NEXT_PUBLIC_MEDUSA_BACKEND_URL: ${DC_N1_NEXT_PUBLIC_MEDUSA_BACKEND_URL:-http://localhost:9000}
        NEXT_PUBLIC_MEDUSA_PUBLISHABLE_KEY: ${DC_N1_NEXT_PUBLIC_MEDUSA_PUBLISHABLE_KEY:-}
    depends_on:
      medusa-be:
        condition: service_healthy
    ports:
      - "8000:3000"
    networks:
      - internal
    environment:
      <<: *n1-env
      NODE_ENV: development
    volumes:
      - .:/var/www
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      start_period: 30s
      interval: 30s
      retries: 5
  medusa-valkey:
    image: valkey/valkey:8-alpine
    healthcheck:
      test: "[ $$(valkey-cli ping) = 'PONG' ]"
      start_period: 5s
      timeout: 3s
      interval: 1s
      retries: 5
    ports:
      - "6379:6379"
    volumes:
      - medusa-valkey-data:/data
    networks:
      - internal
  medusa-minio:
    image: minio/minio
    container_name: wr_medusa_minio
    ports:
      - "9003:9003"
      - "9004:9004"
    volumes:
      - medusa-minio-data:/data
    networks:
      - internal
    command: server /data --console-address ":9003" --address :9004
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9003"]
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
  medusa-meilisearch:
    image: getmeili/meilisearch:v1.35.1
    container_name: wr_medusa_meilisearch
    ports:
      - "7700:7700"
    volumes:
      - medusa-meilisearch-data:/meili_data
    networks:
      - internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7700"]
      interval: 10s
      timeout: 5s
      retries: 5
    environment:
      MEILI_MASTER_KEY: ${DC_MEILI_MASTER_KEY}
      MEILI_NO_ANALYTICS: true
  medusa-db:
    image: postgres:18.1-alpine
    restart: unless-stopped
    command:
      [
        "postgres",
        "-c",
        "shared_preload_libraries=pg_stat_statements",
        "-c",
        "file_copy_method=clone",
      ]
    ports:
      - "${DC_POSTGRES_PUBLIC_PORT:-5432}:5432"
    volumes:
      - ${DC_POSTGRES_VOLUME_DATA:-./.docker_data/db}:/var/lib/postgresql
      - ./docker/development/postgres/initdb:/docker-entrypoint-initdb.d:ro
    networks:
      - internal
    healthcheck:
      test: ["CMD", "pg_isready", "-d", "medusa"]
      start_period: 10s
      interval: 30s
      timeout: 60s
      retries: 3
    environment:
      POSTGRES_PASSWORD: ${DC_POSTGRES_SUPERUSER_PASSWORD:-root}
      POSTGRES_USER: ${DC_POSTGRES_SUPERUSER:-root}
      POSTGRES_DB: ${DC_MEDUSA_APP_DB_NAME:-medusa}
      PGDATA: /var/lib/postgresql/18/docker
      MEDUSA_APP_DB_USER: ${DC_MEDUSA_APP_DB_USER:-medusa_app}
      MEDUSA_APP_DB_PASSWORD: ${DC_MEDUSA_APP_DB_PASSWORD:-medusa_app_change_me}
      MEDUSA_DEV_DB_USER: ${DC_MEDUSA_DEV_DB_USER:-medusa_dev}
      MEDUSA_DEV_DB_PASSWORD: ${DC_MEDUSA_DEV_DB_PASSWORD:-medusa_dev_change_me}
      MEDUSA_APP_DB_NAME: ${DC_MEDUSA_APP_DB_NAME:-medusa}
      MEDUSA_APP_DB_SCHEMA: ${DC_MEDUSA_APP_DB_SCHEMA:-medusa}
  zane-operator-bootstrap:
    restart: "no"
    build:
      context: .
      dockerfile: docker/development/zane-operator/Dockerfile
    entrypoint: ["/app/zane-operator-bootstrap-role"]
    depends_on:
      medusa-db:
        condition: service_healthy
    networks:
      - internal
    environment:
      <<: *zane-operator-db-env
      BOOTSTRAP_ADMIN_PGUSER: ${DC_POSTGRES_SUPERUSER:-root}
      BOOTSTRAP_ADMIN_PGPASSWORD: ${DC_POSTGRES_SUPERUSER_PASSWORD:-root}
  zane-operator:
    restart: unless-stopped
    build:
      context: .
      dockerfile: docker/development/zane-operator/Dockerfile
    depends_on:
      medusa-db:
        condition: service_healthy
      zane-operator-bootstrap:
        condition: service_completed_successfully
    ports:
      - "${DC_ZANE_OPERATOR_PUBLIC_PORT:-8082}:${DC_ZANE_OPERATOR_PORT:-8080}"
    networks:
      - internal
    environment:
      <<: *zane-operator-env
  engine-db:
    image: mariadb:latest
    restart: no
    environment:
      MYSQL_ROOT_PASSWORD: 1234
      MYSQL_DATABASE: wrshop
      MYSQL_USER: wruser
      MYSQL_PASSWORD: 1234
    command: --sql_mode="NO_ENGINE_SUBSTITUTION"
    ports:
      - "3306:3306"
    volumes:
      - ./.docker_data/dbmysql:/var/lib/mysql
      - ./docker/development/mariadb/wr.cnf:/etc/mysql/conf.d/wr.cnf
    networks:
      - internal
  adminer:
    image: adminer
    restart: unless-stopped
    ports:
      - "8081:8080"
    depends_on:
      - medusa-db
    networks:
      - internal
    environment:
      ADMINER_DESIGN: nette
      ADMINER_DEFAULT_SERVER: medusa-db
      ADMINER_PLUGINS: "dump-json"
  caddy:
    build:
      context: ./docker/development/caddy
      dockerfile: Dockerfile
    cap_add:
      - NET_ADMIN
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    networks:
      - internal
    volumes:
      - ./docker/development/caddy/Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    extra_hosts:
      - host.docker.internal:host-gateway
networks:
  internal:
    driver: bridge

volumes:
  medusa-valkey-data:
  medusa-minio-data:
  medusa-meilisearch-data:
  caddy_data:
  caddy_config:
